<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–ª–µ–∫–∞—É—Ç-–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-app: #e0e5ec;
            --text-main: #4a4a4a;
            --radius: 20px;
            --neumorph-shadow-light: #ffffff;
            --neumorph-shadow-dark: #a3b1c6;

            /* === –ö–û–õ–¨–û–†–ò –ì–†–ê–§–Ü–ö–£ (Default) === */
            --chart-bg: #ffffff;
            --light-bg: #fbbf24;   
            --light-text: #1f2937; 
            --dark-bg: #1f2937;    
            --dark-text: #ffffff;  
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* NEUMORPHISM CARD STYLE */
        .card {
            background: var(--bg-app);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: 9px 9px 16px var(--neumorph-shadow-dark), 
                       -9px -9px 16px var(--neumorph-shadow-light);
            border: 1px solid rgba(255,255,255,0.2);
        }

        h2 { margin: 0 0 20px 0; font-weight: 800; color: #333; }

        /* INPUTS */
        .input-neumorph {
            width: 100%;
            border: none;
            border-radius: 12px;
            padding: 15px;
            font-family: inherit;
            background: var(--bg-app);
            box-shadow: inset 6px 6px 10px var(--neumorph-shadow-dark), 
                        inset -6px -6px 10px var(--neumorph-shadow-light);
            box-sizing: border-box;
            color: #333;
            outline: none;
            transition: 0.3s;
        }
        
        .input-neumorph:focus {
            box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), 
                        inset -4px -4px 8px var(--neumorph-shadow-light);
        }

        textarea.input-neumorph { height: 100px; resize: none; font-family: monospace; }
        
        select.input-neumorph {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 12px auto;
        }

        /* BUTTONS */
        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        
        .btn-neu {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            background: var(--bg-app);
            box-shadow: 6px 6px 10px var(--neumorph-shadow-dark), 
                       -6px -6px 10px var(--neumorph-shadow-light);
            color: #333;
            transition: all 0.2s ease;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }

        .btn-neu:active {
            box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), 
                        inset -4px -4px 8px var(--neumorph-shadow-light);
            transform: scale(0.98);
        }

        .btn-primary { color: #007aff; }
        .btn-danger { color: #ff3b30; }
        .btn-action { margin-top: 15px; width: 100%; background: #007aff; color: white; box-shadow: 6px 6px 15px rgba(0,122,255,0.3); }
        .btn-action:active { background: #0063cf; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); }

        /* === –ó–û–ù–ê –ì–ï–ù–ï–†–ê–¶–Ü–á (–ü–†–ò–•–û–í–ê–ù–ê) === */
        #captureTarget {
            background-color: var(--chart-bg);
            padding: 35px;
            border-radius: var(--radius);
            position: absolute; left: -9999px; top: 0; width: 540px; 
            box-sizing: border-box;
            /* –í–∞–∂–ª–∏–≤–æ –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ç—ñ–Ω–µ–π –Ω–∞ –∫–∞—Ä—Ç–∏–Ω—Ü—ñ */
            -webkit-font-smoothing: antialiased;
        }

        .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; }
        .header-title { font-size: 26px; font-weight: 900; text-transform: uppercase; line-height: 1.1; color: #000; }
        .header-subtitle { font-size: 14px; color: #6b7280; font-weight: 500; margin-top: 6px; }
        .logo-fixed { height: 55px; width: auto; object-fit: contain; }

        .grid-container {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 25px;
        }

        .hour-box {
            position: relative; aspect-ratio: 1.5/1; border-radius: 18px; overflow: hidden; 
            font-weight: 700; font-size: 22px; background-color: var(--light-bg);
        }

        .layer-base, .layer-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .layer-base { background-color: var(--light-bg); color: var(--light-text); z-index: 1; }
        .layer-overlay { background-color: var(--dark-bg); color: var(--dark-text); z-index: 2; overflow: hidden; display: none; width: 0; }
        .overlay-content { position: absolute; top: 0; height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; }

        .icon-svg { width: 22px; height: 22px; display: block; flex-shrink: 0; }
        .time-text { display: block; white-space: nowrap; line-height: 1; margin-top: 2px; }

        .footer-info {
            display: flex; align-items: center; gap: 8px; margin-top: 8px; padding-top: 18px;
            border-top: 1px solid #f3f4f6; color: #6b7280;
        }
        .footer-text { font-size: 13px; font-weight: 500; line-height: 1.3; }

        /* –†–ï–ó–£–õ–¨–¢–ê–¢ */
        #outputWrapper { display: none; width: 100%; }
        
        #generatedImage { 
            width: 100%; height: auto; border-radius: 12px; display: block; margin-bottom: 15px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.15);
        }

        /* COPY BLOCK NEUMORPHIC */
        .copy-block {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            background: var(--bg-app);
            box-shadow: 7px 7px 14px var(--neumorph-shadow-dark), 
                       -7px -7px 14px var(--neumorph-shadow-light);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            user-select: none;
        }

        .copy-block:active {
            box-shadow: inset 5px 5px 10px var(--neumorph-shadow-dark), 
                        inset -5px -5px 10px var(--neumorph-shadow-light);
            transform: scale(0.99);
        }
        
        .copy-block.copied {
            background: #e3fae3;
        }

        .copy-content {
            font-family: monospace;
            font-size: 14px;
            color: #333;
            white-space: pre-wrap;
            line-height: 1.4;
            pointer-events: none; /* –©–æ–± –∫–ª—ñ–∫ –ø—Ä–æ—Ö–æ–¥–∏–≤ –Ω–∞ –±–ª–æ–∫ */
        }

        .copy-hint {
            margin-top: 10px;
            font-size: 12px;
            color: #007aff;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .tools-row {
            display: flex; gap: 10px; margin-bottom: 15px;
        }

    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="card">
            <h2>–ë–ª–µ–∫–∞—É—Ç-–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h2>
            
            <div style="margin-bottom: 15px;">
                <label style="font-size:12px; font-weight:bold; color:#666; margin-left:5px; display:block; margin-bottom:5px;">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç—É:</label>
                <select id="headerSelect" class="input-neumorph" onchange="toggleCustomHeader()">
                    <option value="classic">‚ö°Ô∏èüí° –ì–†–ê–§–Ü–ö –ù–ê [–î–ê–¢–ê]</option>
                    <option value="random">üí°üé≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö —á–∏—Å–µ–ª</option>
                    <option value="scifi">üîåüí° –ù–∞—É–∫–æ–≤–æ-—Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫</option>
                    <option value="habit">üí°üîå –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞ –∑–≤–∏—á–∫–æ—é (–∞–≤–∞—Ä—ñ–π–∫–∞)</option>
                    <option value="parallel">üí°‚ö°Ô∏è –ì—Ä–∞—Ñ—ñ–∫ –∑ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ–≥–æ –≤—Å–µ—Å–≤—ñ—Ç—É</option>
                    <option value="dontcare">üí°üîå –ì—Ä–∞—Ñ—ñ–∫, —è–∫–∏–π –Ω–µ –≤–∞—Ä—Ç–æ –ø—Ä–∏–π–º–∞—Ç–∏ –±–ª–∏–∑—å–∫–æ –¥–æ —Å–µ—Ä—Ü—è</option>
                    <option value="custom">‚öôÔ∏è –í–ª–∞—Å–Ω–∞ –Ω–∞–∑–≤–∞...</option>
                </select>
                <input type="text" id="customHeaderInput" class="input-neumorph" style="display:none; margin-top:10px;" placeholder="–í–≤–µ–¥–∏ —Å–≤—ñ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫...">
            </div>

            <textarea id="rawText" class="input-neumorph" placeholder="–í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç –≥—Ä–∞—Ñ—ñ–∫—É –≤—ñ–¥ –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ —Å—é–¥–∏..."></textarea>
            
            <div class="btn-group">
                <button class="btn-neu btn-primary" onclick="processDataAndGenerate()">‚ö° –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                <button class="btn-neu btn-danger" onclick="clearAll()">‚ùå</button>
            </div>
            <div id="debug" style="color:red; font-size:12px; margin-top:10px; text-align:center;"></div>
        </div>

        <div id="outputWrapper">
            
            <div class="tools-row">
                <button class="btn-neu" onclick="saveImageToGallery()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
                <button class="btn-neu" onclick="randomizeTheme()">üé® –ö–æ–ª—ñ—Ä</button>
            </div>

            <img id="generatedImage" src="">

            <div class="copy-block" id="copyBlock" onclick="copyToClipboard()">
                <div class="copy-content" id="finalText">–¢—É—Ç –±—É–¥–µ —Ç–µ–∫—Å—Ç...</div>
                <div class="copy-hint" id="copyHint">–¢–∞–ø–Ω–∏, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç</div>
            </div>
        </div>

    </div>

    <div id="captureTarget">
        <div class="header-row">
            <div>
                <div class="header-title" id="dateDisplay">–ì–†–ê–§–Ü–ö<br>–í–Ü–î–ö–õ–Æ–ß–ï–ù–¨</div>
                <div class="header-subtitle">–ó–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ</div>
            </div>
            <img src="./logo.png" alt="Logo" class="logo-fixed" onerror="this.style.display='none'">
        </div>
        
        <div class="grid-container" id="grid"></div>

        <div class="footer-info">
            <svg style="width:20px; height:20px; flex-shrink:0;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            <div class="footer-text">–ü—ñ–¥ —á–∞—Å –∞–≤–∞—Ä—ñ–π–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –≥—Ä–∞—Ñ—ñ–∫ –Ω–µ –¥—ñ—î</div>
        </div>
    </div>

    <script>
        // === –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ===
        
        // –ü–æ–≤–Ω–∏–π –Ω–∞–±—ñ—Ä –≥–æ–¥–∏–Ω–Ω–∏–∫—ñ–≤
        const clocksFull = {
            '00:00': 'üïõ', '00:30': 'üïß',
            '01:00': 'üïê', '01:30': 'üïú',
            '02:00': 'üïë', '02:30': 'üïù',
            '03:00': 'üïí', '03:30': 'üïû',
            '04:00': 'üïì', '04:30': 'üïü',
            '05:00': 'üïî', '05:30': 'üï†',
            '06:00': 'üïï', '06:30': 'üï°',
            '07:00': 'üïñ', '07:30': 'üï¢',
            '08:00': 'üïó', '08:30': 'üï£',
            '09:00': 'üïò', '09:30': 'üï§',
            '10:00': 'üïô', '10:30': 'üï•',
            '11:00': 'üïö', '11:30': 'üï¶',
            '12:00': 'üïõ', '12:30': 'üïß',
            // —ñ —Ç–∞–∫ –¥–∞–ª—ñ –ø–æ –∫–æ–ª—É, –∞–ª–µ –ø—Ä–æ—Å—Ç—ñ—à–µ —Ñ—É–Ω–∫—Ü—ñ—î—é
        };

        const themes = [
            { bg: '#fbbf24', txt: '#1f2937', darkBg: '#1f2937', darkTxt: '#ffffff' }, // Classic Yellow
            { bg: '#fcd34d', txt: '#000000', darkBg: '#111827', darkTxt: '#ffffff' }, // Brighter Yellow
            { bg: '#fb923c', txt: '#000000', darkBg: '#2d1b0e', darkTxt: '#ffffff' }, // Orange hint
            { bg: '#fef08a', txt: '#000000', darkBg: '#000000', darkTxt: '#fef08a' }, // Pale Yellow / Black
            { bg: '#1f2937', txt: '#ffffff', darkBg: '#000000', darkTxt: '#e5e7eb' }, // Dark Mode (Invertedish)
            { bg: '#eab308', txt: '#ffffff', darkBg: '#1f2937', darkTxt: '#eab308' }, // Deep Gold
        ];

        // –Ü–ö–û–ù–ö–ò
        const iconBulb = `<svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1.2 1.5-2.5 1.5-4a6 6 0 0 0-6-6 6 6 0 0 0-6 6c0 1.4.5 2.7 1.5 4 .7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`;
        const iconZapOff = `<svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="12.41 6.75 13 2 10.57 4.92"/><polyline points="18.57 12.91 21 10 15.66 10"/><polyline points="8 8 3 14 12 14 11 22 16 16"/><line x1="2" y1="2" x2="22" y2="22"/></svg>`;

        // === DOM ===
        const grid = document.getElementById('grid');
        const debug = document.getElementById('debug');
        const dateDisplay = document.getElementById('dateDisplay');
        const finalTextDiv = document.getElementById('finalText');
        const copyBlock = document.getElementById('copyBlock');
        const copyHint = document.getElementById('copyHint');
        const captureTarget = document.getElementById('captureTarget');
        const outputWrapper = document.getElementById('outputWrapper');
        const generatedImage = document.getElementById('generatedImage');
        const headerSelect = document.getElementById('headerSelect');
        const customHeaderInput = document.getElementById('customHeaderInput');

        let hoursStatus = new Array(24).fill('on'); 
        let currentThemeIndex = 0;
        let lastDateStr = "";
        let lastTextIntervals = "";

        // === INIT ===
        function initGrid() {
            grid.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const div = document.createElement('div');
                div.className = 'hour-box';
                const timeStr = i.toString().padStart(2, '0') + ":00";
                
                // –®–∞—Ä 1: –°–≤—ñ—Ç–ª–æ
                const layerBase = document.createElement('div');
                layerBase.className = 'layer-base';
                layerBase.innerHTML = `${iconBulb}<span class="time-text">${timeStr}</span>`;
                
                // –®–∞—Ä 2: –¢–µ–º–Ω–æ
                const layerOverlay = document.createElement('div');
                layerOverlay.className = 'layer-overlay';
                const overlayContent = document.createElement('div');
                overlayContent.className = 'overlay-content';
                overlayContent.innerHTML = `${iconZapOff}<span class="time-text">${timeStr}</span>`;
                
                layerOverlay.appendChild(overlayContent);
                div.appendChild(layerBase);
                div.appendChild(layerOverlay);
                grid.appendChild(div);
            }
        }

        // === –õ–û–ì–Ü–ö–ê ===
        function toggleCustomHeader() {
            if (headerSelect.value === 'custom') {
                customHeaderInput.style.display = 'block';
            } else {
                customHeaderInput.style.display = 'none';
            }
        }

        function getHeaderTitle(dateStr) {
            let base = "";
            switch(headerSelect.value) {
                case 'classic': base = "‚ö°Ô∏èüí° –ì–†–ê–§–Ü–ö"; break;
                case 'random': base = "üí°üé≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö —á–∏—Å–µ–ª –≤—ñ–¥ –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ"; break;
                case 'scifi': base = "üîåüí° –ù–∞—É–∫–æ–≤–æ-—Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫"; break;
                case 'habit': base = "üí°üîå –ö–∞—Ä—Ç–∏–Ω–∫–∞, —è–∫—É –º–∏ –ø–æ—Å—Ç–∏–º–æ –∑–∞ –∑–≤–∏—á–∫–æ—é (–≤—Å–µ –æ–¥–Ω–æ –±—É–¥–µ –∞–≤–∞—Ä—ñ–π–∫–∞, —Ö–µ—Ö–µ)"; break;
                case 'parallel': base = "üí°‚ö°Ô∏è –ì—Ä–∞—Ñ—ñ–∫ –∑ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ–≥–æ –≤—Å–µ—Å–≤—ñ—Ç—É, –≤ —è–∫–æ–º—É –Ω–µ —ñ—Å–Ω—É—î –†–æ—Å—ñ—ó —ñ –∞–≤–∞—Ä—ñ–π–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å"; break;
                case 'dontcare': base = "üí°üîå –ì—Ä–∞—Ñ—ñ–∫, —è–∫–∏–π –Ω–µ –≤–∞—Ä—Ç–æ –ø—Ä–∏–π–º–∞—Ç–∏ –±–ª–∏–∑—å–∫–æ –¥–æ —Å–µ—Ä—Ü—è"; break;
                case 'custom': base = customHeaderInput.value || "‚ö°Ô∏è –ì–†–ê–§–Ü–ö"; break;
                default: base = "‚ö°Ô∏èüí° –ì–†–ê–§–Ü–ö";
            }
            
            // –Ø–∫—â–æ –æ–±—Ä–∞–Ω–æ –ù–ï –∫–ª–∞—Å–∏–∫—É, –¥–æ–¥–∞—î–º–æ "–Ω–∞ [–¥–∞—Ç–∞]" –≤ –∫—ñ–Ω–µ—Ü—å
            // –Ø–∫—â–æ –∫–ª–∞—Å–∏–∫–∞ - —Ç–∞–º —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è "–ì–†–ê–§–Ü–ö –ù–ê [–î–ê–¢–ê]"
            if (headerSelect.value === 'classic') {
                return `${base} –ù–ê ${dateStr}`;
            } else {
                return `${base} –Ω–∞ ${dateStr}`;
            }
        }

        function getClockEmoji(timeStr) {
            // –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ —á–∞—Å
            let [h, m] = timeStr.split(':').map(Number);
            if (isNaN(m)) m = 0;
            
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ —ñ–Ω–¥–µ–∫—Å –≥–æ–¥–∏–Ω–Ω–∏–∫–∞ (12 –≥–æ–¥–∏–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç)
            let emojiTimeH = h % 12; 
            if (emojiTimeH === 0) emojiTimeH = 12; // 12:00 -> üïõ
            
            // –ú–∞—Å–∏–≤ Unicode –≥–æ–¥–∏–Ω–Ω–∏–∫—ñ–≤: [1:00, 2:00 ... 12:00]
            // –ü–æ–ª–æ–≤–∏–Ω–∫–∏: [1:30, 2:30 ... 12:30]
            
            const fullClocks = ['üïõ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö'];
            const halfClocks = ['üïß','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶'];
            
            // –Ü–Ω–¥–µ–∫—Å —É –º–∞—Å–∏–≤—ñ (0 = 12, 1 = 1, 2 = 2...)
            let idx = emojiTimeH === 12 ? 0 : emojiTimeH;
            
            if (m >= 30) return halfClocks[idx];
            return fullClocks[idx];
        }

        function renderSingle(idx) {
            const div = grid.children[idx];
            const status = hoursStatus[idx];
            const overlay = div.querySelector('.layer-overlay');
            const overlayContent = div.querySelector('.overlay-content');
            
            overlay.style.display = 'none';
            overlay.style.left = 'auto'; overlay.style.right = 'auto';
            overlayContent.style.left = 'auto'; overlayContent.style.right = 'auto';

            const boxWidth = div.offsetWidth + 'px';
            overlayContent.style.width = boxWidth;

            if (status === 'off') {
                overlay.style.display = 'block';
                overlay.style.width = '100%';
                overlay.style.left = '0'; overlayContent.style.left = '0';
            }
            else if (status === 'start-half') {
                overlay.style.display = 'block';
                overlay.style.width = '50.5%'; 
                overlay.style.right = '0'; overlayContent.style.right = '0';
            }
            else if (status === 'end-half') {
                overlay.style.display = 'block';
                overlay.style.width = '50.5%';
                overlay.style.left = '0'; overlayContent.style.left = '0';
            }
        }

        function processDataAndGenerate() {
            const text = document.getElementById('rawText').value;
            debug.textContent = "";
            
            // 1. –ü–æ—à—É–∫ –¥–∞—Ç–∏
            const dateRegex = /(\d{1,2})\s+(—Å—ñ—á–Ω—è|–ª—é—Ç–æ–≥–æ|–±–µ—Ä–µ–∑–Ω—è|–∫–≤—ñ—Ç–Ω—è|—Ç—Ä–∞–≤–Ω—è|—á–µ—Ä–≤–Ω—è|–ª–∏–ø–Ω—è|—Å–µ—Ä–ø–Ω—è|–≤–µ—Ä–µ—Å–Ω—è|–∂–æ–≤—Ç–Ω—è|–ª–∏—Å—Ç–æ–ø–∞–¥–∞|–≥—Ä—É–¥–Ω—è)/i;
            const dateMatch = text.match(dateRegex);
            let dateStr = "–°–¨–û–ì–û–î–ù–Ü";
            if (dateMatch) dateStr = dateMatch[0].toUpperCase();
            lastDateStr = dateStr;

            // 2. –ù–∞ –∫–∞—Ä—Ç–∏–Ω—Ü—ñ –ó–ê–í–ñ–î–ò –∫–ª–∞—Å–∏–∫–∞
            dateDisplay.innerHTML = `–ì–†–ê–§–Ü–ö<br>–ù–ê ${dateStr}`;

            // 3. –ü–∞—Ä—Å–∏–Ω–≥ 1.2
            const regex = /(?:^|\n)\s*1\.2\s+([^\n]+)/;
            const match = text.match(regex);
            if (!match) { debug.textContent = "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–≥—É 1.2!"; return; }

            hoursStatus.fill('on');
            let textIntervals = [];
            const ranges = match[1].trim().split(';');

            ranges.forEach(range => {
                range = range.trim();
                if (!range || !/\d/.test(range)) return;
                let parts = range.split(/[\-\‚Äì\‚Äî]/); 
                if (parts.length < 2) return;
                
                let startStr = parts[0].trim(); 
                let endStr = parts[1].trim();

                // –§–Ü–ö–°: —è–∫—â–æ –±–∞—á–∏–º–æ 24:00 -> —Ü–µ 00:00 –¥–ª—è —Ç–µ–∫—Å—Ç—É
                let displayEndStr = endStr === "24:00" ? "00:00" : endStr;
                let displayStartStr = startStr === "24:00" ? "00:00" : startStr;

                applyRange(parseTime(startStr), parseTime(endStr));
                
                // –§–æ—Ä–º—É—î–º–æ —Ä—è–¥–æ–∫: üïï 18:00-21:00
                textIntervals.push(`${getClockEmoji(startStr)} ${displayStartStr}-${displayEndStr}`);
            });

            lastTextIntervals = textIntervals.join('\n');

            // –†–µ–Ω–¥–µ—Ä —ñ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è
            hoursStatus.forEach((_, i) => renderSingle(i));
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤–∏–π –±–ª–æ–∫
            updateCopyText();
            
            outputWrapper.style.display = 'block';
            
            // –ì–µ–Ω–µ—Ä—É—î–º–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é –¥–ª—è —à—Ä–∏—Ñ—Ç—ñ–≤
            setTimeout(generateImageOutput, 150);
        }

        function updateCopyText() {
            const header = getHeaderTitle(lastDateStr);
            finalTextDiv.textContent = `${header}\n\n${lastTextIntervals}\n\n–•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ`;
            copyBlock.classList.remove('copied');
            copyHint.textContent = "–¢–∞–ø–Ω–∏, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç";
            copyHint.style.color = "#007aff";
        }

        function parseTime(t) { 
            const cleaned = t.replace(/[^\d:]/g, '');
            const parts = cleaned.split(':');
            const h = parseInt(parts[0]) || 0;
            const m = parts.length > 1 ? parseInt(parts[1]) : 0;
            return { h: h, m: m }; 
        }

        function applyRange(start, end) {
            let s = start.h * 60 + start.m;
            let e = end.h * 60 + end.m;
            if (e === 0 && end.h === 0) e = 1440; // 00:00 —è–∫ –∫—ñ–Ω–µ—Ü—å
            if (e === 0 && end.h === 24) e = 1440; // 24:00 —è–∫ –∫—ñ–Ω–µ—Ü—å
            if (e < s) e = 1440; // –ø–µ—Ä–µ—Ö—ñ–¥ —á–µ—Ä–µ–∑ –¥–æ–±—É (—Å–ø—Ä–æ—â–µ–Ω–æ)
            
            for (let h = 0; h < 24; h++) {
                let hs = h * 60;
                let he = (h + 1) * 60;
                
                if (hs >= s && he <= e) {
                    hoursStatus[h] = 'off';
                }
                else if (s > hs && s < he) {
                    hoursStatus[h] = start.m >= 30 ? 'start-half' : 'off';
                }
                else if (e > hs && e < he) {
                    hoursStatus[h] = end.m >= 30 ? 'end-half' : 'on';
                }
            }
        }

        function generateImageOutput() {
            html2canvas(captureTarget, {
                scale: 3, 
                backgroundColor: null, // –ø—Ä–æ–∑–æ—Ä–∏–π, —â–æ–± –≤–∑—è—Ç–∏ –∫–æ–ª—ñ—Ä CSS
                logging: false,
                useCORS: true
            }).then(canvas => {
                generatedImage.src = canvas.toDataURL('image/png');
            });
        }

        // === –ü–õ–Æ–®–ö–ò ===

        function copyToClipboard() {
            const text = finalTextDiv.textContent;
            navigator.clipboard.writeText(text).then(() => {
                copyBlock.classList.add('copied');
                copyHint.textContent = "–°–ö–û–ü–Ü–ô–û–í–ê–ù–û! ‚úÖ";
                copyHint.style.color = "#28a745";
                if(navigator.vibrate) navigator.vibrate(50);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –°–ø—Ä–æ–±—É–π –≤—Ä—É—á–Ω—É.");
            });
        }

        async function saveImageToGallery() {
            if (!generatedImage.src) return;
            
            try {
                const response = await fetch(generatedImage.src);
                const blob = await response.blob();
                const file = new File([blob], "grafik.png", { type: "image/png" });

                if (navigator.share) {
                    await navigator.share({
                        files: [file]
                    });
                } else {
                    // Fallback –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø—É / —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤
                    const link = document.createElement("a");
                    link.href = generatedImage.src;
                    link.download = "grafik.png";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (err) {
                console.error("Error sharing:", err);
                alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π –∑—Ä–æ–±–∏—Ç–∏ —Å–∫—Ä—ñ–Ω—à–æ—Ç.");
            }
        }

        function randomizeTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            const t = themes[currentThemeIndex];
            
            const root = document.documentElement;
            root.style.setProperty('--light-bg', t.bg);
            root.style.setProperty('--light-text', t.txt);
            root.style.setProperty('--dark-bg', t.darkBg);
            root.style.setProperty('--dark-text', t.darkTxt);
            
            // –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –∑ –Ω–æ–≤–∏–º–∏ –∫–æ–ª—å–æ—Ä–∞–º–∏
            // –°–ø–æ—á–∞—Ç–∫—É –æ–Ω–æ–≤–∏–º–æ DOM —Å—ñ—Ç–∫—É
            hoursStatus.forEach((_, i) => renderSingle(i));
            setTimeout(generateImageOutput, 100);
        }

        function clearAll() {
            document.getElementById('rawText').value = '';
            hoursStatus.fill('on');
            initGrid();
            outputWrapper.style.display = 'none';
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        initGrid();
        window.addEventListener('resize', () => { hoursStatus.forEach((_, i) => renderSingle(i)); });

    </script>
</body>
</html>

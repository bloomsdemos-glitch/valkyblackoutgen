<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–ª–µ–∫–∞—É—Ç-–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 14.0 Pro</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-app: #f2f2f7;
            --card-bg: #ffffff;
            --text-main: #000000;
            --radius: 20px;
        }

        /* –¢–ï–ú–ò (CSS Variables –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞) */
        
        /* –¢–µ–º–∞ 0: –ö–ª–∞—Å–∏–∫–∞ (–ñ–æ–≤—Ç–∏–π —Ñ–æ–Ω, —Ç–µ–º–Ω–∏–π —Ç–µ–∫—Å—Ç) */
        .theme-0 {
            --gen-bg: #ffffff;
            --cell-bg: #fbbf24;
            --cell-text: #1f2937;
            --overlay-bg: #1f2937;
            --overlay-text: #ffffff;
            --stroke-light: #1f2937;
            --stroke-dark: #ffffff;
        }

        /* –¢–µ–º–∞ 1: –ú'—è–∫–∏–π (–ü–∞—Å—Ç–µ–ª—å–Ω–∏–π –∂–æ–≤—Ç–∏–π) */
        .theme-1 {
            --gen-bg: #fffbeb;
            --cell-bg: #fcd34d;
            --cell-text: #451a03;
            --overlay-bg: #78350f;
            --overlay-text: #fffbeb;
            --stroke-light: #451a03;
            --stroke-dark: #fffbeb;
        }

        /* –¢–µ–º–∞ 2: –Ü–Ω–≤–µ—Ä—Å—ñ—è (–¢–µ–º–Ω–∏–π —Ä–µ–∂–∏–º) */
        .theme-2 {
            --gen-bg: #111827;
            --cell-bg: #374151; /* –°—ñ—Ä–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π */
            --cell-text: #fbbf24; /* –ñ–æ–≤—Ç–∏–π —Ç–µ–∫—Å—Ç */
            --overlay-bg: #000000; /* –ß–æ—Ä–Ω–∏–π –≤–∏–º–∫–Ω–µ–Ω–æ */
            --overlay-text: #9ca3af;
            --stroke-light: #fbbf24;
            --stroke-dark: #9ca3af;
        }
         /* –¢–µ–º–∞ 2: Header fix override inside JS needed or handled via variable inheritance depending on text color */
        .theme-2 .header-title { color: #fbbf24 !important; }
        .theme-2 .header-subtitle { color: #9ca3af !important; }
        .theme-2 .footer-text { color: #9ca3af !important; }
        .theme-2 .footer-info { border-top-color: #374151 !important; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        .app-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; }

        .card {
            background: var(--card-bg); padding: 20px;
            border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        textarea {
            width: 100%; height: 80px; border: 1px solid #e5e7eb; border-radius: 12px;
            padding: 10px; font-family: monospace; background: #f9fafb;
            color: var(--text-main); box-sizing: border-box; resize: none; margin-bottom: 15px;
        }

        /* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è —Å–µ–ª–µ–∫—Ç–∞ */
        select, input[type="text"] {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e5e7eb;
            background: #f9fafb; font-size: 14px; margin-bottom: 10px; box-sizing: border-box;
            appearance: none; -webkit-appearance: none;
        }

        #customTitleInput { display: none; margin-top: -5px; }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button {
            flex: 1; padding: 14px; border: none; border-radius: 12px;
            font-weight: 700; font-size: 15px; cursor: pointer; transition: 0.2s;
        }
        .btn-primary { background: #007aff; color: white; }
        .btn-secondary { background: #e5e7eb; color: var(--text-main); }
        .btn-theme { flex: 0 0 50px; font-size: 20px; padding: 0; display: flex; align-items: center; justify-content: center;}

        /* === –ó–û–ù–ê –ì–ï–ù–ï–†–ê–¶–Ü–á === */
        #captureTarget {
            /* –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ CSS –∑–º—ñ–Ω–Ω—ñ —Ç–µ–º–∏ */
            background-color: var(--gen-bg);
            padding: 35px; border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            position: absolute; left: -9999px; top: 0; width: 540px; box-sizing: border-box;
        }

        .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; }
        .header-title { font-size: 26px; font-weight: 900; text-transform: uppercase; line-height: 1.1; color: #000; }
        .header-subtitle { font-size: 14px; color: #6b7280; font-weight: 500; margin-top: 6px; }
        .logo-fixed { height: 55px; width: auto; object-fit: contain; }

        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 25px; }

        .hour-box {
            position: relative; aspect-ratio: 1.5/1; border-radius: 18px; overflow: hidden;
            font-weight: 700; font-size: 22px; border: none;
            background-color: var(--cell-bg); /* Theme var */
        }

        .layer-base {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background-color: var(--cell-bg); color: var(--cell-text); z-index: 1;
        }

        .layer-overlay {
            position: absolute; top: 0; height: 100%; overflow: hidden; z-index: 2;
            background-color: var(--overlay-bg); color: var(--overlay-text);
            width: 0; display: none;
        }

        .overlay-content {
            position: absolute; top: 0; height: 100%; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap;
        }

        .icon-svg { width: 22px; height: 22px; display: block; flex-shrink: 0; }
        .time-text { display: block; white-space: nowrap; line-height: 1; margin-top: 2px; }

        .footer-info {
            display: flex; align-items: center; gap: 8px; margin-top: 8px; padding-top: 18px;
            border-top: 1px solid #f3f4f6; color: #6b7280;
        }
        .footer-text { font-size: 13px; font-weight: 500; line-height: 1.3; }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
        #outputContainer {
            display: none; background: var(--card-bg); padding: 15px;
            border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center;
        }
        #generatedImage { width: 100%; height: auto; border-radius: 12px; display: block; margin-bottom: 10px;}
        
        .copy-block {
            background: #f3f4f6; border-radius: 12px; padding: 15px;
            text-align: left; font-family: -apple-system, sans-serif; font-size: 14px; line-height: 1.4;
            cursor: pointer; position: relative; border: 2px solid transparent; transition: 0.2s;
        }
        .copy-block:active { background: #e5e7eb; transform: scale(0.98); }
        .copy-hint { 
            position: absolute; top: -10px; right: 10px; background: #000; color: #fff; 
            font-size: 10px; padding: 2px 6px; border-radius: 4px; opacity: 0; transition: 0.3s;
        }

    </style>
</head>
<body class="theme-0"> <div class="app-container">
        
        <div class="card">
            <h2 style="margin:0 0 10px 0; color:var(--text-main);">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 14.0 Pro</h2>
            
            <select id="titleSelect" onchange="toggleCustomInput()">
                <option value="classic">‚ö°Ô∏èüí° –ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨</option>
                <option value="custom">‚úèÔ∏è –°–≤—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç (–ö–∞—Å—Ç–æ–º–Ω–∏–π)</option>
                <option disabled>--- –°–ê–†–ö–ê–ó–ú ---</option>
                <option value="‚ö°Ô∏èüí° –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö —á–∏—Å–µ–ª –≤—ñ–¥ –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ">‚ö°Ô∏èüí° –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö —á–∏—Å–µ–ª</option>
                <option value="‚ö°Ô∏èüí° –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω–∏ –≤—ñ–¥ –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ">‚ö°Ô∏èüí° –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω–∏</option>
                <option value="‚ö°Ô∏èüí° –ù–∞—É–∫–æ–≤–æ-—Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫">‚ö°Ô∏èüí° –ù–∞—É–∫–æ–≤–æ-—Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫</option>
                <option value="‚ö°Ô∏èüí° –ö–∞—Ä—Ç–∏–Ω–∫–∞, —è–∫—É –º–∏ –ø–æ—Å—Ç–∏–º–æ –∑–∞ –∑–≤–∏—á–∫–æ—é">‚ö°Ô∏èüí° –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞ –∑–≤–∏—á–∫–æ—é</option>
                <option value="‚ö°Ô∏èüí° –ì—Ä–∞—Ñ—ñ–∫ –∑ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ–≥–æ –≤—Å–µ—Å–≤—ñ—Ç—É">‚ö°Ô∏èüí° –ì—Ä–∞—Ñ—ñ–∫ –∑ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ–≥–æ –≤—Å–µ—Å–≤—ñ—Ç—É</option>
                <option value="‚ö°Ô∏èüí° –ì—Ä–∞—Ñ—ñ–∫, —è–∫–∏–π –Ω–µ –≤–∞—Ä—Ç–æ –ø—Ä–∏–π–º–∞—Ç–∏ –±–ª–∏–∑—å–∫–æ –¥–æ —Å–µ—Ä—Ü—è">‚ö°Ô∏èüí° –ì—Ä–∞—Ñ—ñ–∫ "–Ω–µ –ø—Ä–∏–π–º–∞–π—Ç–µ –±–ª–∏–∑—å–∫–æ"</option>
                <option value="‚ö°Ô∏èüí° –•–≤–∏–ª–∏–Ω–∫–∞ –≥–∞–∑–ª–∞–π—Ç–∏–Ω–≥—É –≤—ñ–¥ –û–±–ª–µ–Ω–µ—Ä–≥–æ">‚ö°Ô∏èüí° –•–≤–∏–ª–∏–Ω–∫–∞ –≥–∞–∑–ª–∞–π—Ç–∏–Ω–≥—É</option>
                <option value="‚ö°Ô∏èüí° –ì—Ä–∞—Ñ—ñ–∫ –®—Ä–µ–¥—ñ–Ω–≥–µ—Ä–∞ (–≤–µ—Ä—Å—ñ—è Pro Max)">‚ö°Ô∏èüí° –ì—Ä–∞—Ñ—ñ–∫ –®—Ä–µ–¥—ñ–Ω–≥–µ—Ä–∞</option>
                <option value="‚ö°Ô∏èüí° –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥–∏ –≤ –¥–æ–º—ñ: –ø–µ—Ä–µ–≤–∞–∂–Ω–æ —Ç–µ–º–Ω–æ">‚ö°Ô∏èüí° –ü—Ä–æ–≥–Ω–æ–∑: –ø–µ—Ä–µ–≤–∞–∂–Ω–æ —Ç–µ–º–Ω–æ</option>
                <option value="‚ö°Ô∏èüí° –ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å ¬´–Ø–∫ –∫–∞—Ä—Ç–∞ –ª—è–∂–µ¬ª">‚ö°Ô∏èüí° –ì—Ä–∞—Ñ—ñ–∫ ¬´–Ø–∫ –∫–∞—Ä—Ç–∞ –ª—è–∂–µ¬ª</option>
            </select>
            
            <input type="text" id="customTitleInput" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å–≤—ñ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫...">

            <textarea id="rawText" placeholder="–í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç –≥—Ä–∞—Ñ—ñ–∫—É —Å—é–¥–∏..."></textarea>
            
            <div class="btn-group">
                <button class="btn-primary" onclick="processAndGenerate()">‚ö° –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                <button class="btn-secondary btn-theme" onclick="cycleTheme()">üé®</button>
                <button class="btn-secondary" onclick="window.location.reload()">üîÑ</button>
            </div>
        </div>

        <div id="captureTarget">
            <div class="header-row">
                <div>
                    <div class="header-title" id="imgTitle">–ì–†–ê–§–Ü–ö<br>–í–Ü–î–ö–õ–Æ–ß–ï–ù–¨</div>
                    <div class="header-subtitle">–ó–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ</div>
                </div>
                <img src="./logo.png" alt="" class="logo-fixed" onerror="this.style.display='none'">
            </div>
            <div class="grid-container" id="grid"></div>
            <div class="footer-info">
                <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                <div class="footer-text">–ü—ñ–¥ —á–∞—Å –∞–≤–∞—Ä—ñ–π–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –≥—Ä–∞—Ñ—ñ–∫ –Ω–µ –¥—ñ—î</div>
            </div>
        </div>

        <div id="outputContainer">
            <img id="generatedImage" src="">
            <button class="btn-primary" style="margin-bottom:15px; width:100%;" onclick="shareImage()">üì• –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –§–æ—Ç–æ (Share)</button>
            
            <div class="copy-block" id="copyBlock" onclick="copyTextDiv()">
                <div class="copy-hint" id="copyHint">–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!</div>
                <div id="finalTextContent" style="white-space: pre-wrap;"></div>
            </div>
        </div>

    </div>

    <script>
        // === CONFIG ===
        let currentThemeIndex = 0;
        const totalThemes = 3; // 0, 1, 2
        let globalBlob = null; // –î–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
        
        // –Ü–∫–æ–Ω–∫–∏ (–æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ –ø—ñ–¥ —Ç–µ–º—É)
        function getIcons(themeIdx) {
            // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–ª—å–æ—Ä–∏ –∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∏–ª—é #captureTarget
            const style = getComputedStyle(document.getElementById('captureTarget'));
            const strokeLight = style.getPropertyValue('--stroke-light').trim();
            const strokeDark = style.getPropertyValue('--stroke-dark').trim();

            return {
                bulb: `<svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="${strokeLight}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1.2 1.5-2.5 1.5-4a6 6 0 0 0-6-6 6 6 0 0 0-6 6c0 1.4.5 2.7 1.5 4 .7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`,
                zap: `<svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="${strokeDark}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="12.41 6.75 13 2 10.57 4.92"/><polyline points="18.57 12.91 21 10 15.66 10"/><polyline points="8 8 3 14 12 14 11 22 16 16"/><line x1="2" y1="2" x2="22" y2="22"/></svg>`
            };
        }

        // Clock Map for correct Emojis
        const clockMap = {
            '00': 'üïõ', '01': 'üïê', '02': 'üïë', '03': 'üïí', '04': 'üïì', '05': 'üïî',
            '06': 'üïï', '07': 'üïñ', '08': 'üïó', '09': 'üïò', '10': 'üïô', '11': 'üïö',
            '12': 'üïõ', '13': 'üïê', '14': 'üïë', '15': 'üïí', '16': 'üïì', '17': 'üïî',
            '18': 'üïï', '19': 'üïñ', '20': 'üïó', '21': 'üïò', '22': 'üïô', '23': 'üïö'
        };
        const halfClockMap = {
            '00': 'üïß', '01': 'üïú', '02': 'üïù', '03': 'üïû', '04': 'üïü', '05': 'üï†',
            '06': 'üï°', '07': 'üï¢', '08': 'üï£', '09': 'üï§', '10': 'üï•', '11': 'üï¶',
            '12': 'üïß', '13': 'üïú', '14': 'üïù', '15': 'üïû', '16': 'üïü', '17': 'üï†',
            '18': 'üï°', '19': 'üï¢', '20': 'üï£', '21': 'üï§', '22': 'üï•', '23': 'üï¶'
        };

        function getClockEmoji(timeStr) {
            // timeStr format "HH:MM"
            const [h, m] = timeStr.split(':');
            let hourKey = parseInt(h, 10);
            if (hourKey > 23) hourKey = 0; // Fix 24
            hourKey = hourKey.toString().padStart(2, '0');
            
            if (m === '30') {
                return halfClockMap[hourKey] || 'üïí';
            }
            return clockMap[hourKey] || 'üïí';
        }

        function toggleCustomInput() {
            const select = document.getElementById('titleSelect');
            const customInput = document.getElementById('customTitleInput');
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
            }
        }

        function cycleTheme() {
            const target = document.getElementById('captureTarget');
            // Remove current theme class
            target.classList.remove(`theme-${currentThemeIndex}`);
            
            // Next theme
            currentThemeIndex = (currentThemeIndex + 1) % totalThemes;
            
            // Add new theme class
            target.classList.add(`theme-${currentThemeIndex}`);
            
            // Re-render grid icons because SVG color depends on CSS vars
            renderGrid(lastHoursData); 

            // If an image is already generated, regenerate it live
            if (document.getElementById('outputContainer').style.display === 'block') {
                generateImageOnly();
            }
        }

        let lastHoursData = new Array(24).fill('on'); // Store state for re-rendering

        function parseText(raw) {
            // Auto-fix 24:00 -> 00:00
            raw = raw.replace(/24:00/g, '00:00');

            const lines = raw.split('\n');
            const hours = new Array(24).fill('on'); 
            const timeRegex = /(\d{1,2}:\d{2})\s*[-‚Äì]\s*(\d{1,2}:\d{2})/g;
            let match;

            for (const line of lines) {
                while ((match = timeRegex.exec(line)) !== null) {
                    let start = match[1];
                    let end = match[2];

                    let [sh, sm] = start.split(':').map(Number);
                    let [eh, em] = end.split(':').map(Number);

                    // Normalize
                    if (sh === 24) sh = 0;
                    if (eh === 24) eh = 0;

                    let startVal = sh + sm/60;
                    let endVal = eh + em/60;
                    if (endVal <= startVal) endVal += 24; 

                    for (let i = 0; i < 24; i++) {
                        // Check logic: if hour i falls inside range
                        // Simple full hour check
                        if (i >= startVal && i < endVal) {
                             hours[i] = 'off';
                        }
                    }
                }
            }
            return hours;
        }

        function renderGrid(hours) {
            lastHoursData = hours;
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            const icons = getIcons(currentThemeIndex);

            for (let i = 0; i < 24; i++) {
                const div = document.createElement('div');
                div.className = 'hour-box';
                const timeStr = i.toString().padStart(2, '0') + ":00";
                
                // Base Layer
                const layerBase = document.createElement('div');
                layerBase.className = 'layer-base';
                layerBase.innerHTML = `${icons.bulb}<span class="time-text">${timeStr}</span>`;
                
                // Overlay Layer
                const layerOverlay = document.createElement('div');
                layerOverlay.className = 'layer-overlay';
                
                const overlayContent = document.createElement('div');
                overlayContent.className = 'overlay-content';
                overlayContent.innerHTML = `${icons.zap}<span class="time-text">${timeStr}</span>`;
                
                layerOverlay.appendChild(overlayContent);
                div.appendChild(layerBase);
                div.appendChild(layerOverlay);

                // Set State
                if (hours[i] === 'off') {
                    layerOverlay.style.display = 'block';
                    layerOverlay.style.width = '100%';
                }

                grid.appendChild(div);
            }
        }

        function generateTextOutput(hours) {
            const select = document.getElementById('titleSelect');
            let chosenTitle = select.value;
            
            if (chosenTitle === 'custom') {
                const customVal = document.getElementById('customTitleInput').value.trim();
                chosenTitle = customVal ? `‚ö°Ô∏èüí° ${customVal}` : '‚ö°Ô∏èüí° –ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨';
            } else if (chosenTitle === 'classic') {
                chosenTitle = '‚ö°Ô∏èüí° –ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨';
            }

            // Date logic (Next day if evening?) - keeping simple: Today/Tomorrow based on user intent usually.
            // Let's just say "–ù–ê [–î–ê–¢–ê]"
            const options = { month: 'long', day: 'numeric' };
            const today = new Date().toLocaleDateString('uk-UA', options);
            const tomorrow = new Date(new Date().getTime() + 24 * 60 * 60 * 1000).toLocaleDateString('uk-UA', options);
            
            // Simple heuristic: if it's after 18:00, suggest tomorrow, else today.
            // Or just hardcode "–ù–ê [–°–¨–û–ì–û–î–ù–Ü/–ó–ê–í–¢–†–ê]" placeholder or actual date.
            // Let's use Tomorrow if current hour > 15, else Today.
            const isLate = new Date().getHours() > 15;
            const dateStr = isLate ? tomorrow : today;

            let result = `${chosenTitle} –ù–ê ${dateStr.toUpperCase()}\n\n`;

            // Group ranges
            let ranges = [];
            let currentStart = null;
            
            for (let i = 0; i < 25; i++) {
                const isOff = (i < 24) ? (hours[i] === 'off') : false;
                
                if (isOff && currentStart === null) {
                    currentStart = i;
                } else if (!isOff && currentStart !== null) {
                    // Range ended at i
                    let startStr = currentStart.toString().padStart(2,'0') + ":00";
                    let endStr = i.toString().padStart(2,'0') + ":00";
                    
                    // Emoji Logic with Half-hour fix (though grid is hourly, text can be whatever)
                    // Since grid is hourly, we just use full hours here.
                    const emoji = getClockEmoji(startStr);
                    result += `${emoji} ${startStr}-${endStr}\n`;
                    currentStart = null;
                }
            }

            result += `\n–•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ <\n\n–ù–µ –∑–∞–±—É–≤–∞–π—Ç–µ –ø—Ä–æ –ø–∞–≤–µ—Ä–±–∞–Ω–∫–∏!`;
            return result;
        }

        async function generateImageOnly() {
            const captureTarget = document.getElementById('captureTarget');
            
            // Ensure Image Title is always CLASSIC for the render
            // (It is static in HTML, so no JS needed to change it, 
            // unless we accidentally changed it elsewhere. It is safe.)

            // Wait for icons to render/load
            await new Promise(r => setTimeout(r, 50)); 

            const canvas = await html2canvas(captureTarget, {
                scale: 2, 
                backgroundColor: null 
            });

            canvas.toBlob(blob => {
                globalBlob = blob;
                const url = URL.createObjectURL(blob);
                document.getElementById('generatedImage').src = url;
            }, 'image/png');
        }

        function processAndGenerate() {
            const raw = document.getElementById('rawText').value;
            if(!raw) return;

            // 1. Parse & Render Grid
            const hours = parseText(raw);
            
            // Set initial theme if not set
            const target = document.getElementById('captureTarget');
            if(!target.classList.contains('theme-0') && !target.classList.contains('theme-1') && !target.classList.contains('theme-2')) {
                target.classList.add(`theme-${currentThemeIndex}`);
            }
            
            renderGrid(hours); // Render grid using current theme colors

            // 2. Render Text
            const textOutput = generateTextOutput(hours);
            document.getElementById('finalTextContent').innerText = textOutput;

            // 3. Show Output Area
            document.getElementById('outputContainer').style.display = 'block';

            // 4. Generate Image
            generateImageOnly();
        }

        // Copy Text Function (Tap on block)
        function copyTextDiv() {
            const text = document.getElementById('finalTextContent').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const hint = document.getElementById('copyHint');
                hint.style.opacity = '1';
                hint.style.top = '-25px';
                setTimeout(() => {
                    hint.style.opacity = '0';
                    hint.style.top = '-10px';
                }, 2000);
            });
        }

        // Share Image (Native iOS)
        async function shareImage() {
            if (!globalBlob) return;
            
            const file = new File([globalBlob], "grafik.png", { type: "image/png" });
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        files: [file]
                    });
                } catch (err) {
                    console.log("Share canceled or failed", err);
                }
            } else {
                alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –Ω–∞—Ç–∏–≤–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è. –ó–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏.");
            }
        }
    </script>
</body>
</html>
